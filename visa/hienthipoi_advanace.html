<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Excel → Marker Cluster Map4D</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- MAP4D SDK 2.6 -->
  <script defer src="https://api.map4d.vn/sdk/map/js?version=2.6&key=93d393d0f6507ee00b62fe01db7430fa"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Arial;
      background: #f7f9fc;
    }

    #layout {
      display: flex;
      height: 100vh;
      width: 100%;
    }

    #leftPanel {
      width: 360px;
      background: white;
      border-right: 1px solid #e3e6ee;
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 8px rgba(0,0,0,0.05);
    }

    #controls {
      padding: 16px;
      border-bottom: 1px solid #e0e3ed;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #fafbfe;
    }

    #controls select,
    #controls input[type=file] {
      padding: 8px 10px;
      border: 1px solid #d0d6e4;
      border-radius: 6px;
      background: white;
      outline: none;
      transition: 0.2s;
      font-size: 14px;
    }

    #controls select:hover {
      border-color: #9cb6ff;
    }

    #controls button {
      padding: 10px;
      background: #4178ff;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: 0.25s;
    }

    #controls button:hover {
      background: #1d5fff;
    }

    #poiList {
      flex: 1;
      overflow-y: auto;
      padding: 14px;
    }

    .poi-item {
      padding: 10px 12px;
      background: white;
      border: 1px solid #eef1f7;
      border-radius: 6px;
      margin-bottom: 10px;
      transition: 0.2s;
    }

    .poi-item:hover {
      background: #f2f7ff;
      border-color: #c2d7ff;
    }

    #map {
      flex: 1;
      min-width: 300px;
    }

    #poiList::-webkit-scrollbar { width: 8px; }
    #poiList::-webkit-scrollbar-track { background: #f0f3f7; }
    #poiList::-webkit-scrollbar-thumb {
      background: #c0c8d2;
      border-radius: 4px;
    }
    #poiList::-webkit-scrollbar-thumb:hover {
      background: #9aa4b1;
    }
  </style>
</head>

<body>

<div id="layout">

  <!-- LEFT PANEL -->
  <div id="leftPanel">

    <div id="controls">
      <input type="file" id="fileInput" accept=".xlsx,.xls" />

      Sheet:
      <select id="sheetSelect"><option value="">-- chọn sheet --</option></select>

      Lat:
      <select id="latCol"></select>

      Lng:
      <select id="lngCol"></select>

      Name:
      <select id="nameCol"></select>

      Status:
      <select id="colorCol"></select>

      <button id="plotBtn" disabled>Vẽ Marker</button>
    </div>

    <div id="poiList"></div>

  </div>

  <!-- MAP -->
  <div id="map"></div>
</div>


<script>
let map;
let markers = [];
let excelRows = [];
let workbook;
let allPoints = [];

/* ✅ ICONVIEW CHO MARKER ĐƠN */
function iconHTML(color) {
  return `
    <div style="
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: ${color};
      border: 2px solid white;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    "></div>
  `;
}

/* ✅ ICONVIEW CHO CLUSTER */
function clusterIconHTML(color, text) {
  return `
    <div style="
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: ${color};
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
      font-weight: 700;
      border: 2px solid white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.35);
    ">
      ${text}
    </div>
  `;
}

/* ✅ PICK COLOR */
function pickColor(val) {
  val = String(val || "").trim().toLowerCase();
  if (val === "available") return "#ff3b30";  // đỏ
  if (val === "update")    return "#1976ff";  // xanh dương
  return "#2ecc71";                              // xanh lá
}

/* ✅ INIT MAP */
document.addEventListener("DOMContentLoaded", () => {
  map = new map4d.Map(document.getElementById("map"), {
    center: { lat: 10.775658, lng: 106.700424 },
    zoom: 13
  });

  map.addListener("cameraChanged", () => {
    if (allPoints.length > 0) drawClusters(allPoints);
  });
});

/* ✅ FILL SELECT */
function fillSelect(id, headers) {
  const sel = document.getElementById(id);
  sel.innerHTML = `<option value="">-- chọn cột --</option>`;
  headers.forEach(h => sel.innerHTML += `<option value="${h}">${h}</option>`);
}

/* ✅ LOAD EXCEL FILE */
document.getElementById("fileInput").addEventListener("change", async e => {
  const file = e.target.files?.[0];
  if (!file) return;

  const buffer = await file.arrayBuffer();
  workbook = XLSX.read(buffer);

  const sheetNames = workbook.SheetNames;

  const sheetSelect = document.getElementById("sheetSelect");
  sheetSelect.innerHTML = `<option value="">-- chọn sheet --</option>`;
  sheetNames.forEach(s => sheetSelect.innerHTML += `<option value="${s}">${s}</option>`);
});

/* ✅ LOAD SHEET → LOAD COLUMNS */
document.getElementById("sheetSelect").addEventListener("change", () => {
  const sheetName = document.getElementById("sheetSelect").value;
  if (!sheetName) return;

  const sheet = workbook.Sheets[sheetName];
  excelRows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

  const headers = Object.keys(excelRows[0]);
  fillSelect("latCol", headers);
  fillSelect("lngCol", headers);
  fillSelect("nameCol", headers);
  fillSelect("colorCol", headers);

  document.getElementById("plotBtn").disabled = false;
});

/* ✅ TO NUMBER */
function toNumber(x) {
  if (!x) return null;
  x = String(x).replace(",", ".").trim();
  const n = parseFloat(x);
  return isNaN(n) ? null : n;
}

/* ✅ VẼ MARKER */
document.getElementById("plotBtn").addEventListener("click", () => {

  const latCol   = document.getElementById("latCol").value;
  const lngCol   = document.getElementById("lngCol").value;
  const nameCol  = document.getElementById("nameCol").value;
  const statusCol = document.getElementById("colorCol").value;

  markers.forEach(m => m.setMap(null));
  markers = [];
  allPoints = [];

  let html = "";

  excelRows.forEach(row => {

    const lat = toNumber(row[latCol]);
    const lng = toNumber(row[lngCol]);
    const name = row[nameCol] || "";
    const statusVal = row[statusCol] || "";

    if (lat !== null && lng !== null) {

      allPoints.push({ lat, lng, name, statusVal });

      html += `<div class="poi-item">
        <b>${name}</b><br>
        Lat: ${lat} — Lng: ${lng}<br>
        Status: ${statusVal}
      </div>`;
    }
  });

  document.getElementById("poiList").innerHTML = html;

  drawClusters(allPoints);
  fitBounds(allPoints);
});

/* ✅ CLUSTER GRID */
function gridCluster(points, size) {
  const grid = {};
  points.forEach(p => {
    const key = Math.floor(p.lat / size) + "_" + Math.floor(p.lng / size);
    if (!grid[key]) grid[key] = [];
    grid[key].push(p);
  });
  return Object.values(grid);
}

function getZoom() {
  return map.getCamera().zoom;
}

/* ✅ DRAW CLUSTERS + MARKERS */
function drawClusters(points) {
  markers.forEach(m => m.setMap(null));
  markers = [];

  const zoom = getZoom();
  const gridSize = zoom >= 15 ? 0.004 : zoom >= 12 ? 0.01 : 0.02;

  const clusters = gridCluster(points, gridSize);

  clusters.forEach(group => {

    /* ✅ CLUSTER ICON */
    if (group.length > 1 && zoom < 15) {

      const lat = avg(group.map(p => p.lat));
      const lng = avg(group.map(p => p.lng));

      const color = pickColor(group[0].statusVal);

      const marker = new map4d.Marker({
        position: { lat, lng },
        label: null,                                         // ✅ KHÔNG CHO HIỂN THỊ LABEL (FIX icon dư)
        iconView: clusterIconHTML(color, group.length),
        iconViewSize: { width: 28, height: 28 },
        anchor: [0.5, 0.5]
      });

      marker.setMap(map);
      markers.push(marker);
      return;
    }

    /* ✅ MARKER ĐƠN */
    group.forEach(p => {
      const color = pickColor(p.statusVal);

      const marker = new map4d.Marker({
        position: { lat: p.lat, lng: p.lng },
        label: p.name || "",                                 // ✅ TÊN BÊN CẠNH ICON
        iconView: iconHTML(color),
        iconViewSize: { width: 14, height: 14 },             // ✅ KHÔNG fallback icon mặc định
        anchor: [0.0, 0.5]                                   // ✅ label nằm bên phải icon
      });

      marker.setMap(map);
      markers.push(marker);
    });
  });
}

function avg(arr) {
  return arr.reduce((a,b)=>a+b,0) / arr.length;
}

/* ✅ FIT MAP */
function fitBounds(points) {
  let minLat = 90, maxLat = -90, minLng = 180, maxLng = -180;

  points.forEach(p => {
    minLat = Math.min(minLat, p.lat);
    maxLat = Math.max(maxLat, p.lat);
    minLng = Math.min(minLng, p.lng);
    maxLng = Math.max(maxLng, p.lng);
  });

  map.setCenter({ lat: (minLat + maxLat)/2, lng: (minLng + maxLng)/2 });

  const span = Math.max(maxLat - minLat, maxLng - minLng);
  map.setZoom(span < 0.01 ? 14 : span < 0.05 ? 12 : span < 0.2 ? 10 : 8);
}

</script>
</body>
</html>
